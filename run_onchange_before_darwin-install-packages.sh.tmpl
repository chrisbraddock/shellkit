{{ if and (eq .chezmoi.os "darwin") (eq .profile "full") -}}
#!/usr/bin/env bash
set -euo pipefail

if ! command -v brew >/dev/null 2>&1; then
  echo "ERROR: Homebrew not found. Install first: https://brew.sh/" >&2
  exit 3
fi

echo "==> Installing packages (macOS)..."

brew bundle --file=/dev/stdin <<'EOF'
{{- range .packages.shell }}
brew {{ . | quote }}
{{- end }}
{{- range .packages.editor }}
brew {{ . | quote }}
{{- end }}
{{- range .packages.tools }}
brew {{ . | quote }}
{{- end }}
{{- range .packages.monitoring }}
brew {{ . | quote }}
{{- end }}
{{- range .packages.darwin.brew }}
{{- if or (not (has . (list "mactop" "macmon"))) (eq $.chezmoi.arch "arm64") }}
brew {{ . | quote }}
{{- end }}
{{- end }}
{{- range .packages.darwin.cask }}
cask {{ . | quote }}
{{- end }}
EOF

# FZF post-install (keybindings)
if [[ -f "$(brew --prefix)/opt/fzf/install" ]]; then
  "$(brew --prefix)/opt/fzf/install" --key-bindings --completion --no-update-rc --no-bash --no-fish 2>/dev/null || true
fi

# iTerm2 shell integration
if [[ ! -f "${HOME}/.iterm2_shell_integration.zsh" ]]; then
  echo "==> Installing iTerm2 shell integration..."
  curl -fsSL https://iterm2.com/shell_integration/install_shell_integration.sh | bash
fi

# Pip packages via pipx
if command -v pipx &>/dev/null; then
  echo "==> Installing pip packages via pipx..."
{{- range .packages.pip }}
  pipx install {{ . | quote }} || true
{{- end }}
fi

echo "==> Package installation complete"
{{ end -}}
